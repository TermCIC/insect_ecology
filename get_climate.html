<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Climate Data Viewer (Daily)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-8">
    
    <h1 class="text-3xl font-bold mb-4 text-blue-700">Climate Data Viewer (Daily)</h1>
    <p class="mb-6 text-gray-600">Enter coordinates to fetch daily mean temperature and humidity for a full year.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <input id="lat" type="number" step="0.0001" placeholder="Latitude" class="border rounded-lg p-3" />
      <input id="lon" type="number" step="0.0001" placeholder="Longitude" class="border rounded-lg p-3" />
      <input id="year" type="number" min="1950" max="2100" placeholder="Year" class="border rounded-lg p-3" />
    </div>

    <button id="fetchBtn" onclick="fetchClimate()" 
      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow">
      Get Climate Data
    </button>
    <div id="statsPanel" class="mt-10 mx-auto text-center p-6 bg-gray-50 rounded-xl shadow-lg hidden max-w-3xl"></div>
    <div id="loading" class="mt-4 text-blue-600 font-semibold hidden">
      Loading daily climate data… Please wait.
    </div>

    <div class="mt-8">
      <h3 class="font-bold text-lg text-red-600 mb-2">Temperature</h3>
      <canvas id="tempChart" class="w-full h-80"></canvas>
    
      <h3 class="font-bold text-lg text-blue-600 mt-10 mb-2">Humidity</h3>
      <canvas id="humChart" class="w-full h-80"></canvas>
    </div>

    <div class="mt-6 flex gap-4">
      <button id="downloadBtn" style="display:none;" 
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow"
        onclick="downloadData()">Download JSON</button>

      <button id="downloadCsvBtn" style="display:none;" 
        class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg shadow"
        onclick="downloadCSV()">Download CSV</button>
    </div>
    <p class="text-sm text-gray-500 mt-8">by Assistant Professor Dr. Chun-I Chiu</p>
    <p class="text-sm text-gray-500 mt-8">Department of Entomology and Plant Pathology, Chiang Mai University</p>
    <p class="text-sm text-gray-500 mt-8">
      Climate data provided by 
      <a href="https://open-meteo.com/" target="_blank" class="text-blue-600 underline">Open-Meteo</a>.
      Thank you Open-Meteo!
    </p>

  </div>

  <script>
  let tempChart;
  let humChart;
  let lastData = null;
  
  async function fetchClimate() {
    const lat = document.getElementById('lat').value;
    const lon = document.getElementById('lon').value;
    const year = document.getElementById('year').value;
    const btn = document.getElementById("fetchBtn");
    const loading = document.getElementById("loading");
    const statsPanel = document.getElementById("statsPanel");
  
    if (!lat || !lon || !year) {
      alert("Please fill all fields");
      return;
    }
  
    const start = `${year}-01-01`;
    const end   = `${year}-12-31`;
  
    const url =
      `https://archive-api.open-meteo.com/v1/era5?latitude=${lat}&longitude=${lon}` +
      `&start_date=${start}&end_date=${end}` +
      `&daily=temperature_2m_mean,temperature_2m_max,temperature_2m_min,` +
      `relative_humidity_2m_mean,relative_humidity_2m_min,relative_humidity_2m_max,` +
      `precipitation_sum,et0_fao_evapotranspiration` +
      `&timezone=auto`;
  
    btn.disabled = true;
    btn.classList.add("opacity-50");
    loading.classList.remove("hidden");
  
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
  
      const data = await res.json();
      lastData = data;
  
      if (!data.daily || !data.daily.time) {
        alert("No climate data!");
        return;
      }
  
      const d = data.daily;
  
      const dates = d.time.map(t => new Date(t));
      const months = dates.map(d => d.getMonth());
  
      // Annual values
      const meanTemp = avg(d.temperature_2m_mean);
      const meanHum  = avg(d.relative_humidity_2m_mean);
      const totalP   = sum(d.precipitation_sum);
      const totalPET = sum(d.et0_fao_evapotranspiration);
      const AI       = totalP / totalPET;
  
      // Annual absolute extremes
      const yearMinTemp = min(d.temperature_2m_min);
      const yearMaxTemp = max(d.temperature_2m_max);
  
      const yearMinHum  = min(d.relative_humidity_2m_min);
      const yearMaxHum  = max(d.relative_humidity_2m_max);
  
      // Monthly aggregation
      let monthly = {};
      for (let i = 0; i < 12; i++) {
        monthly[i] = {
          temp: [], tempMin: [], tempMax: [],
          hum: [], humMin: [], humMax: [],
          precip: 0,
          pet: 0
        };
      }
  
      for (let i = 0; i < dates.length; i++) {
        let m = months[i];
  
        monthly[m].temp.push(d.temperature_2m_mean[i]);
        monthly[m].tempMin.push(d.temperature_2m_min[i]);
        monthly[m].tempMax.push(d.temperature_2m_max[i]);
        monthly[m].hum.push(d.relative_humidity_2m_mean[i]);
        monthly[m].humMin.push(d.relative_humidity_2m_min[i]);
        monthly[m].humMax.push(d.relative_humidity_2m_max[i]);
        monthly[m].precip += d.precipitation_sum[i];
        monthly[m].pet += d.et0_fao_evapotranspiration[i];
      }
  
      // ===== Monthly summary table =====
      let monthlyHTML = `
        <table class="mx-auto mt-4 text-sm table-auto border-collapse">
          <thead>
            <tr class="bg-blue-100">
              <th class="border px-2 py-1">Month</th>
              <th class="border px-2 py-1">T Mean (°C)</th>
              <th class="border px-2 py-1">T Min</th>
              <th class="border px-2 py-1">T Max</th>
              <th class="border px-2 py-1">RH Mean (%)</th>
              <th class="border px-2 py-1">Precip (mm)</th>
              <th class="border px-2 py-1">PET (mm)</th>
            </tr>
          </thead>
          <tbody>
      `;
  
      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  
      for (let m = 0; m < 12; m++) {
        monthlyHTML += `
          <tr>
            <td class="border px-2 py-1">${monthNames[m]}</td>
            <td class="border px-2 py-1">${avg(monthly[m].temp).toFixed(1)}</td>
            <td class="border px-2 py-1">${min(monthly[m].tempMin).toFixed(1)}</td>
            <td class="border px-2 py-1">${max(monthly[m].tempMax).toFixed(1)}</td>
            <td class="border px-2 py-1">${avg(monthly[m].hum).toFixed(1)}</td>
            <td class="border px-2 py-1">${monthly[m].precip.toFixed(1)}</td>
            <td class="border px-2 py-1">${monthly[m].pet.toFixed(1)}</td>
          </tr>
        `;
      }
      monthlyHTML += `</tbody></table>`;
  
      // ===== Stats Panel =====
      statsPanel.classList.remove("hidden");
      statsPanel.innerHTML = `
        <h2 class="text-2xl font-bold text-blue-700 mb-2">Annual Climate Summary (${year})</h2>
  
        <p><strong>Mean Temperature:</strong> ${meanTemp.toFixed(2)} °C</p>
        <p><strong>Lowest Temperature of Year:</strong> ${yearMinTemp.toFixed(2)} °C</p>
        <p><strong>Highest Temperature of Year:</strong> ${yearMaxTemp.toFixed(2)} °C</p>
  
        <br>
  
        <p><strong>Mean Humidity:</strong> ${meanHum.toFixed(1)} %</p>
        <p><strong>Lowest Humidity of Year:</strong> ${yearMinHum.toFixed(1)} %</p>
        <p><strong>Highest Humidity of Year:</strong> ${yearMaxHum.toFixed(1)} %</p>
  
        <br>
  
        <p><strong>Total Precipitation:</strong> ${totalP.toFixed(1)} mm</p>
        <p><strong>Total PET:</strong> ${totalPET.toFixed(1)} mm</p>
        <p class="mb-6"><strong>UNEP Aridity Index (P/PET):</strong> ${AI.toFixed(3)}</p>
  
        <h3 class="text-xl font-bold text-blue-700 mt-6 mb-2">Monthly Climate Summary</h3>
        ${monthlyHTML}
      `;
  
      // Draw separate charts
      drawTempChart(d.time, d.temperature_2m_mean);
      drawHumChart(d.time, d.relative_humidity_2m_mean);

      // Show download buttons
      document.getElementById('downloadBtn').style.display = 'inline-block';
      document.getElementById('downloadCsvBtn').style.display = 'inline-block';
  
    } catch (err) {
      alert("Error: " + err);
    }
  
    btn.disabled = false;
    btn.classList.remove("opacity-50");
    loading.classList.add("hidden");
  }
  
  // Helper functions
  const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const min = arr => Math.min(...arr);
  const max = arr => Math.max(...arr);
  
  // Separate Temperature Figure
  function drawTempChart(labels, temperature) {
    const ctx = document.getElementById('tempChart').getContext('2d');
    if (tempChart) tempChart.destroy();
  
    tempChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          { label: "Temperature (°C)", data: temperature, borderColor: "red", borderWidth: 2 }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            ticks: {
              callback: function(val) {
                return new Date(this.getLabelForValue(val))
                  .toLocaleString("en-US", { month: "short" });
              }
            }
          }
        }
      }
    });
  }
  
  // Separate Humidity Figure
  function drawHumChart(labels, humidity) {
    const ctx = document.getElementById('humChart').getContext('2d');
    if (humChart) humChart.destroy();
  
    humChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          { label:"Humidity (%)", data:humidity, borderColor:"blue", borderWidth:2 }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            ticks: {
              callback: function(val) {
                return new Date(this.getLabelForValue(val))
                  .toLocaleString("en-US", { month: "short" });
              }
            }
          }
        }
      }
    });
  }
  
  </script>


</body>
</html>
