<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Climate Data Viewer</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen p-6">
<div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-8">

  <h1 class="text-3xl font-bold mb-4 text-blue-700">Climate Data Viewer</h1>

  <!-- Coordinate Format -->
  <div class="mb-4">
    <label class="font-semibold">Coordinate Format</label>
    <select id="coordFormat" onchange="switchFormat()" class="border p-3 rounded w-full mt-1">
      <option value="wgs84">WGS84 (Decimal Degrees)</option>
      <option value="dms">DMS (Degrees Minutes Seconds)</option>
      <option value="utm">UTM</option>
    </select>
  </div>

  <!-- WGS84 -->
  <div id="inputWGS84" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <input id="lat" type="number" step="0.0001" placeholder="Latitude" class="border p-3 rounded" />
    <input id="lon" type="number" step="0.0001" placeholder="Longitude" class="border p-3 rounded" />
  </div>

  <!-- DMS -->
  <div id="inputDMS" class="hidden mb-4">
    <!-- Lat -->
    <div class="grid grid-cols-4 gap-2 mb-2">
      <select id="latDir" class="border p-3 rounded"><option value="N">N</option><option value="S">S</option></select>
      <input id="latD" type="number" placeholder="Lat °" class="border p-3 rounded">
      <input id="latM" type="number" placeholder="Lat ′" class="border p-3 rounded">
      <input id="latS" type="number" placeholder="Lat ″" class="border p-3 rounded">
    </div>
    <!-- Lon -->
    <div class="grid grid-cols-4 gap-2 mb-2">
      <select id="lonDir" class="border p-3 rounded"><option value="E">E</option><option value="W">W</option></select>
      <input id="lonD" type="number" placeholder="Lon °" class="border p-3 rounded">
      <input id="lonM" type="number" placeholder="Lon ′" class="border p-3 rounded">
      <input id="lonS" type="number" placeholder="Lon ″" class="border p-3 rounded">
    </div>
  </div>

  <!-- UTM -->
  <div id="inputUTM" class="hidden mb-4">
    <div class="grid grid-cols-3 gap-2">
      <input id="utmZone" type="text" placeholder="47Q" class="border p-3 rounded">
      <input id="utmE" type="number" placeholder="Easting" class="border p-3 rounded">
      <input id="utmN" type="number" placeholder="Northing" class="border p-3 rounded">
    </div>
  </div>

  <!-- Date -->
  <div class="grid grid-cols-2 gap-4 mb-4">
    <div><label>Start Date</label><input id="startDate" type="date" class="border p-3 rounded w-full"></div>
    <div><label>End Date</label><input id="endDate" type="date" class="border p-3 rounded w-full"></div>
  </div>

  <button onclick="fetchClimate()" id="fetchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded shadow">
    Get Climate Data
  </button>

  <div id="loading" class="hidden mt-4 text-blue-600 font-semibold">
    Loading climate data… Please wait.
  </div>

  <div id="statsPanel" class="hidden mt-10 bg-gray-50 rounded p-6 shadow"></div>

  <!-- Charts -->
  <div class="mt-10">
    <h3 class="font-bold text-red-600 mb-2">Temperature</h3>
    <canvas id="tempChart"></canvas>

    <h3 class="font-bold text-blue-600 mt-10 mb-2">Humidity</h3>
    <canvas id="humChart"></canvas>
  </div>

</div>

<!-- Citation -->
<div class="mt-12 p-6 bg-gray-100 border rounded text-sm text-gray-700">
  <h3 class="font-bold text-lg mb-3">How to Cite This Tool</h3>

  <p class="mb-4">
    <strong>This Climate Viewer:</strong><br>
    Chiu, C.-I. (2025). Climate Data Viewer. Chiang Mai University.<br>
    Retrieved from https://termcic.github.io/insect_ecology/get_climate.html
  </p>

  <p>
    <strong>Open-Meteo Weather API:</strong><br>
    Zippenfenig, P. (2023). Open-Meteo.com Weather API [Software]. Zenodo.<br>
    https://doi.org/10.5281/zenodo.7970649
  </p>
</div>

<script>
let tempChart, humChart;
let lastData = null;

/* Switch coordinate format */
function switchFormat() {
  const f = document.getElementById("coordFormat").value;
  inputWGS84.classList.add("hidden");
  inputDMS.classList.add("hidden");
  inputUTM.classList.add("hidden");

  if (f === "wgs84") inputWGS84.classList.remove("hidden");
  if (f === "dms") inputDMS.classList.remove("hidden");
  if (f === "utm") inputUTM.classList.remove("hidden");
}

function dmsToDecimal(d,m,s) { return Number(d) + m/60 + s/3600; }

/* Simple UTM → Lat Lon */
function utmToLatLon(zone, E, N) {
  let hemisphere = zone.slice(-1).toUpperCase() >= "N" ? "N" : "S";
  let zoneNum = parseInt(zone);

  const a = 6378137;
  const e = 0.081819191;
  const k0 = 0.9996;

  let x = E - 500000;
  let y = hemisphere === "S" ? N - 10000000 : N;

  const m = y / k0;
  const mu = m / (a * (1 - e*e/4 - 3*e**4/64));

  const phi1 = mu + (3*e/2 - 27*e**3/32)*Math.sin(2*mu);

  const lon = (x / (a*k0)) / Math.cos(phi1);
  const lat = phi1 - (Math.tan(phi1)*(x*x)) / (2*a*a*k0*k0);

  const lonDeg = lon*(180/Math.PI) + (zoneNum - 1)*6 - 180 + 3;
  const latDeg = lat*(180/Math.PI);

  return { lat: latDeg, lon: lonDeg };
}

/* FETCH CLIMATE DATA */
async function fetchClimate() {
  const fmt = coordFormat.value;
  let lat, lon;

  if (fmt === "wgs84") {
    lat = parseFloat(document.getElementById("lat").value);
    lon = parseFloat(document.getElementById("lon").value);
  }
  if (fmt === "dms") {
    lat = dmsToDecimal(latD.value, latM.value, latS.value);
    if (latDir.value === "S") lat = -lat;
    lon = dmsToDecimal(lonD.value, lonM.value, lonS.value);
    if (lonDir.value === "W") lon = -lon;
  }
  if (fmt === "utm") {
    const r = utmToLatLon(utmZone.value, parseFloat(utmE.value), parseFloat(utmN.value));
    lat = r.lat;
    lon = r.lon;
  }

  if (isNaN(lat) || isNaN(lon)) {
    alert("Invalid coordinates!");
    return;
  }

  const start = startDate.value;
  const end = endDate.value;
  if (!start || !end) {
    alert("Please choose start and end dates.");
    return;
  }

  loading.classList.remove("hidden");

  const url =
    `https://archive-api.open-meteo.com/v1/era5?latitude=${lat}&longitude=${lon}` +
    `&start_date=${start}&end_date=${end}` +
    `&daily=temperature_2m_mean,relative_humidity_2m_mean` +
    `&timezone=auto`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    lastData = data;
    const d = data.daily;

    statsPanel.classList.remove("hidden");
    statsPanel.innerHTML = `
      <h2 class="text-2xl font-bold text-blue-700 mb-3">
        Climate Summary (${start} to ${end})
      </h2>
      <p><strong>Mean Temperature:</strong> ${avg(d.temperature_2m_mean).toFixed(2)} °C</p>
      <p><strong>Mean Humidity:</strong> ${avg(d.relative_humidity_2m_mean).toFixed(1)} %</p>
    `;

    drawTempChart(d.time, d.temperature_2m_mean);
    drawHumChart(d.time, d.relative_humidity_2m_mean);

  } catch (err) {
    alert("Error: " + err);
  }

  loading.classList.add("hidden");
}

function avg(arr){return arr.reduce((a,b)=>a+b,0)/arr.length;}

function drawTempChart(labels, data) {
  if (tempChart) tempChart.destroy();
  tempChart = new Chart(tempChart, {
    type:"line",
    data:{ labels, datasets:[{label:"Temperature (°C)", data, borderColor:"red"}] }
  });
}

function drawHumChart(labels, data) {
  if (humChart) humChart.destroy();
  humChart = new Chart(humChart, {
    type:"line",
    data:{ labels, datasets:[{label:"Humidity (%)", data, borderColor:"blue"}] }
  });
}
</script>

</body>
</html>