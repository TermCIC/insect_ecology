<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Climate Data Viewer (Daily)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-8">
    
    <h1 class="text-3xl font-bold mb-4 text-blue-700">Climate Data Viewer (Daily)</h1>
    <p class="mb-6 text-gray-600">Enter coordinates to fetch daily mean temperature and humidity for a full year.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <input id="lat" type="number" step="0.0001" placeholder="Latitude" class="border rounded-lg p-3" />
      <input id="lon" type="number" step="0.0001" placeholder="Longitude" class="border rounded-lg p-3" />
      <input id="year" type="number" min="1950" max="2100" placeholder="Year" class="border rounded-lg p-3" />
    </div>

    <button id="fetchBtn" onclick="fetchClimate()" 
      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow">
      Get Climate Data
    </button>

    <div id="loading" class="mt-4 text-blue-600 font-semibold hidden">
      Loading daily climate data… Please wait.
    </div>

    <div class="mt-8">
      <canvas id="climateChart" class="w-full h-96"></canvas>
    </div>

    <div class="mt-6 flex gap-4">
      <button id="downloadBtn" style="display:none;" 
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow"
        onclick="downloadData()">Download JSON</button>

      <button id="downloadCsvBtn" style="display:none;" 
        class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg shadow"
        onclick="downloadCSV()">Download CSV</button>
    </div>
    <p class="text-sm text-gray-500 mt-8">by Assistant Professor Dr. Chun-I Chiu</p>
    <p class="text-sm text-gray-500 mt-8">Department of Entomology and Plant Pathology, Chiang Mai University</p>
    <p class="text-sm text-gray-500 mt-8">
      Climate data provided by 
      <a href="https://open-meteo.com/" target="_blank" class="text-blue-600 underline">Open-Meteo</a>.
      Thank you Open-Meteo!
    </p>

  </div>

  <script>
let chart;
let lastData = null;

async function fetchClimate() {
  const lat = document.getElementById('lat').value;
  const lon = document.getElementById('lon').value;
  const year = document.getElementById('year').value;
  const btn = document.getElementById("fetchBtn");
  const loading = document.getElementById("loading");
  const statsPanel = document.getElementById("statsPanel");

  if (!lat || !lon || !year) {
    alert("Please fill all fields");
    return;
  }

  const start = `${year}-01-01`;
  const end   = `${year}-12-31`;

  const url =
    `https://archive-api.open-meteo.com/v1/era5?latitude=${lat}&longitude=${lon}` +
    `&start_date=${start}&end_date=${end}` +
    `&daily=temperature_2m_mean,relative_humidity_2m_mean,precipitation_sum,et0_fao_evapotranspiration` +
    `&timezone=auto`;

  btn.disabled = true;
  btn.classList.add("opacity-50");
  loading.classList.remove("hidden");

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    lastData = data;

    if (!data.daily || !data.daily.time) {
      alert("No daily climate data available for this location/year.");
      return;
    }

    const days = data.daily.time;
    const temp = data.daily.temperature_2m_mean;
    const hum  = data.daily.relative_humidity_2m_mean;
    const p    = data.daily.precipitation_sum;
    const pet  = data.daily.et0_fao_evapotranspiration;

    const totalP   = p.reduce((a, b) => a + b, 0);
    const totalPET = pet.reduce((a, b) => a + b, 0);
    const AI = totalP / totalPET;

    // Show statistics below figure
    statsPanel.classList.remove("hidden");
    statsPanel.innerHTML = `
      <h2 class="text-xl font-bold mb-2 text-blue-700">Annual Climate Summary (${year})</h2>
      <p><strong>Mean Temperature:</strong> ${avg(temp).toFixed(2)} °C</p>
      <p><strong>Mean Humidity:</strong> ${avg(hum).toFixed(1)} %</p>
      <p><strong>Total Precipitation:</strong> ${totalP.toFixed(1)} mm</p>
      <p><strong>Total PET:</strong> ${totalPET.toFixed(1)} mm</p>
      <p><strong>UNEP Aridity Index (P/PET):</strong> 
         <span class="font-bold">${AI.toFixed(3)}</span>
      </p>
    `;

    drawChart(days, temp, hum);

    document.getElementById('downloadBtn').style.display = 'inline-block';
    document.getElementById('downloadCsvBtn').style.display = 'inline-block';

  } catch (err) {
    alert("Failed to fetch climate data:\n" + err);
  }

  btn.disabled = false;
  btn.classList.remove("opacity-50");
  loading.classList.add("hidden");
}

function avg(arr) {
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}

function drawChart(labels, temperature, humidity) {
  const ctx = document.getElementById('climateChart').getContext('2d');
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Daily Mean Temperature (°C)",
          data: temperature,
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 2,
          fill: false
        },
        {
          label: "Daily Mean Humidity (%)",
          data: humidity,
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 2,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: {
            callback: function(value, index) {
              const date = new Date(this.getLabelForValue(value));
              return date.toLocaleString("en-US", { month: "short" });
            },
            autoSkip: true,
            maxRotation: 0
          }
        }
      }
    }
  });
}

function downloadData() {
  const blob = new Blob([JSON.stringify(lastData, null, 2)], {
    type: "application/json"
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "climate_data_daily.json";
  a.click();
  URL.revokeObjectURL(url);
}

function downloadCSV() {
  if (!lastData) return;

  const d = lastData.daily;
  let csv = "date,temp_mean,humidity_mean,precip_mm,pet_mm\n";

  for (let i = 0; i < d.time.length; i++) {
    csv += `${d.time[i]},${d.temperature_2m_mean[i]},${d.relative_humidity_2m_mean[i]},${d.precipitation_sum[i]},${d.et0_fao_evapotranspiration[i]}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "climate_daily_with_aridity.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

<div id="statsPanel" class="mt-8 p-4 bg-gray-100 rounded-lg shadow hidden"></div>



</body>
</html>
