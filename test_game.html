<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>KAPLAY RPG Demo</title>
<script src="https://unpkg.com/kaplay/dist/kaplay.js"></script>
</head>

<body style="margin:0;background:black;">
<script>

// Wrap the game logic in an async function and call it immediately
(async () => {
  const k = kaplay({
    background: [30, 30, 30],
    scale: 2,
  });

  // --- Load sprites ---
  // The await calls are now valid inside this async function
  await loadSprite("hero","https://play.kaplayjs.com/sprites/apple.png");
  await loadSprite("wall", "https://play.kaplayjs.com/sprites/apple.pngg");
  await loadSprite("floor", "https://play.kaplayjs.com/sprites/apple.png");

  // --- Tilemap data ---
  const map = [
    "################",
    "#..............#",
    "#..............#",
    "#......##......#",
    "#..............#",
    "#......##......#",
    "#..............#",
    "################",
  ];

  // Convert tilemap to objects
  map.forEach((row, y) => {
    [...row].forEach((ch, x) => {

      if (ch === "#") {
        add([
          sprite("wall"),
          pos(x * 16, y * 16),
          area(),
          solid(),
        ]);
      }

      if (ch === ".") {
        add([
          sprite("floor"),
          pos(x * 16, y * 16),
        ]);
      }
    });
  });

  // --- Player ---
  const player = add([
    sprite("hero"),
    pos(32, 32),
    area(),
    solid(),
    { speed: 80 }
  ]);

  // Camera follow
  player.onUpdate(() => {
    camPos(player.pos);
  });

  // Movement
  onKeyDown("left", () => player.move(-player.speed, 0));
  onKeyDown("right", () => player.move(player.speed, 0));
  onKeyDown("up", () => player.move(0, -player.speed));
  onKeyDown("down", () => player.move(0, player.speed));
})(); // Immediately invoking the async function

</script>
</body>
</html>
