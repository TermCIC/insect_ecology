<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Kaplay Raycaster RPG (Official Assets)</title>
<script src="https://unpkg.com/kaplay/dist/kaplay.js"></script>
</head>

<body style="margin:0;background:black;">
<script>

const k = kaplay({
  background: [20, 20, 20],
  scale: 2,
});

// Load official assets
await loadSprite("hero",  "https://kaboomjs.com/sprites/dungeon/hero.png");
await loadSprite("wall",  "https://kaboomjs.com/sprites/dungeon/wall.png");
await loadSprite("floor", "https://kaboomjs.com/sprites/dungeon/floor.png");
await loadSprite("door_c","https://kaboomjs.com/sprites/dungeon/door_closed.png");
await loadSprite("door_o","https://kaboomjs.com/sprites/dungeon/door_open.png");

// -------------------------
// Tilemap
// -------------------------
const map = [
  "################",
  "#..............#",
  "#..............#",
  "#......##......#",
  "#..............#",
  "#......##......#",
  "#..............#",
  "################",
];

const walls = [];

map.forEach((row, y) => {
  [...row].forEach((ch, x) => {

    if (ch === "#") {
      const w = add([
        sprite("wall"),
        pos(x * 16, y * 16),
        area(),
        solid(),
        { isWall: true }
      ]);
      walls.push(w);
    }

    if (ch === ".") {
      add([
        sprite("floor"),
        pos(x * 16, y * 16),
      ]);
    }
  });
});

// -------------------------
// Player with Direction
// -------------------------
const player = add([
  sprite("hero"),
  pos(32, 32),
  area(),
  solid(),
  {
    speed: 90,
    angle: 0,
    dir: vec2(1, 0),
  }
]);

player.onUpdate(() => camPos(player.pos));

// -------------------------
// LEFT / RIGHT Rotate
// -------------------------
onKeyDown("left", () => {
  player.angle -= 2;
  player.dir = vec2(Math.cos(rad(player.angle)), Math.sin(rad(player.angle)));
});

onKeyDown("right", () => {
  player.angle += 2;
  player.dir = vec2(Math.cos(rad(player.angle)), Math.sin(rad(player.angle)));
});

// -------------------------
// Move Forward / Backward
// -------------------------
onKeyDown("up", () => {
  player.move(player.dir.x * player.speed, player.dir.y * player.speed);
});
onKeyDown("down", () => {
  player.move(-player.dir.x * player.speed, -player.dir.y * player.speed);
});

// -------------------------
// Raycast + Depth Shading
// -------------------------
function raycast() {
  const step = 4;
  const maxDist = 200;
  let posRay = player.pos.clone();

  for (let d = 0; d < maxDist; d += step) {
    posRay = posRay.add(player.dir.scale(step));

    for (const w of walls) {
      if (w.area && w.area.hasPoint(posRay)) {
        return d;
      }
    }
  }
  return maxDist;
}

onUpdate(() => {
  for (const w of walls) {
    const dist = w.pos.dist(player.pos);
    const shade = Math.max(0.2, 1 - dist / 180);
    w.color = rgb(shade * 255, shade * 255, shade * 255);
  }
});

</script>
</body>
</html>