<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>KAPLAY – My First Game</title>
  <script src="https://unpkg.com/kaplay/dist/kaplay.js"></script>
</head>

<body style="margin:0; padding:0; background:#87CEEB;">
<script>
(async () => {
  // 初始化遊戲
  kaplay();

  // 載入精靈圖（範例中使用 "bean" 精靈）
  await loadSprite("bean", "https://play.kaplayjs.com/bean.png");

  // 定義場景 “game”
  scene("game", () => {

    // 設定重力
    setGravity(1600);

    // 玩家角色
    const player = add([
      sprite("bean"),
      pos(width()/4, 0),
      area(),
      body(),
    ]);

    // 地面平台
    const FLOOR_HEIGHT = 48;
    add([
      rect(width(), FLOOR_HEIGHT),
      pos(0, height() - FLOOR_HEIGHT),
      anchor("botleft"),
      area(),
      body({ isStatic: true }),
      color(127, 200, 255),
    ]);

    // 跳躍功能
    const JUMP_FORCE = 800;
    function jump() {
      if (player.isGrounded()) {
        player.jump(JUMP_FORCE);
      }
    }
    onKeyPress("space", jump);
    onClick(jump);

    // 障礙物生成
    const SPEED = 480;
    function spawnTree() {
      add([
        rect(48, rand(32, 96)),
        area(),
        pos(width(), height() - FLOOR_HEIGHT),
        anchor("botleft"),
        color(255, 180, 255),
        move(LEFT, SPEED),
        "tree",
      ]);
      wait(rand(0.5, 1.5), spawnTree);
    }
    spawnTree();

    // 若撞到 “tree” 則 Game Over
    player.onCollide("tree", () => {
      go("lose", score);
      addKaboom(player.pos);
    });

    // 計分系統
    let score = 0;
    const scoreLabel = add([
      text(score),
      pos(24, 24),
      scale(2)
    ]);
    onUpdate(() => {
      score++;
      scoreLabel.text = score;
    });

  });

  // 定義 “lose” 場景
  scene("lose", (score) => {
    add([
      sprite("bean"),
      pos(width()/2, height()/2 - 80),
      scale(3),
      anchor("center")
    ]);
    add([
      text("Score: " + score),
      pos(width()/2, height()/2 + 20),
      scale(2),
      anchor("center")
    ]);
    onKeyPress("space", () => go("game"));
    onClick(() => go("game"));
  });

  // 啟動遊戲
  go("game");

})();
</script>
</body>
</html>