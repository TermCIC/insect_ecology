<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Insect Sampling Record</title>

<style>
    body {
        font-family: system-ui, sans-serif;
        padding: 16px;
        background: #f5f5f5;
    }
    label { font-weight: bold; }
    select, input {
        width: 100%;
        padding: 8px;
        margin: 6px 0 12px 0;
        font-size: 16px;
    }
    button {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        font-size: 16px;
        background: #333;
        color: white;
        border: none;
        border-radius: 4px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        background: white;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
    }
    th {
        background: #e0e0e0;
    }
</style>

</head>
<body>

<h2>Insect Sampling Record</h2>

<!-- Species -->
<label>Insect species</label>
<select id="species">
    <option value="No insects">No insects</option>
</select>

<button onclick="addSpecies()">Add new species</button>

<!-- Number of insects -->
<label>Number of insects</label>
<input id="insectCount" type="number" min="0" placeholder="Example: 20">

<!-- Habitat or host plant -->
<label>Host plant or habitat</label>
<select id="habitat">
    <option value="Not specific">Not specific</option>
</select>

<button onclick="addHabitat()">Add new host plant or habitat</button>

<!-- GPS -->
<label>GPS coordinates (lat, lon)</label>
<input id="gpsInput" type="text" placeholder="Example: 18.796, 98.952">

<button onclick="getGPS()">Get GPS</button>
<button onclick="addRecord()">Record Sample</button>

<table id="recordTable">
    <thead>
        <tr>
            <th>No.</th>
            <th>Species</th>
            <th>Count</th>
            <th>Habitat</th>
            <th>GPS</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button onclick="exportCSV()">Export CSV</button>
<button onclick="exportKML()">Export KML for Google Earth</button>

<script>
/* Add species */
function addSpecies() {
    const name = prompt("Enter new termite species name:");
    if (!name) return;
    const select = document.getElementById("species");
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
    select.value = name;
}

/* Add habitat */
function addHabitat() {
    const name = prompt("Enter new host plant or habitat:");
    if (!name) return;
    const select = document.getElementById("habitat");
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
    select.value = name;
}

/* GPS function */
function getGPS() {
    if (!navigator.geolocation) {
        alert("GPS is not supported by this device");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            document.getElementById("gpsInput").value = lat + ", " + lon;
        },
        err => {
            alert("Failed to get GPS");
        }
    );
}

let records = [];

/* Add record */
function addRecord() {
    const species = document.getElementById("species").value;
    const count = document.getElementById("insectCount").value || "0";
    const habitat = document.getElementById("habitat").value;
    const gps = document.getElementById("gpsInput").value.trim();

    if (gps === "") {
        alert("Please enter GPS");
        return;
    }

    const time = new Date().toLocaleString();

    const record = { species, count, habitat, gps, time };
    records.push(record);
    updateTable();
}

/* Update table */
function updateTable() {
    const tbody = document.getElementById("recordTable").querySelector("tbody");
    tbody.innerHTML = "";

    records.forEach((r, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${i + 1}</td>
            <td>${r.species}</td>
            <td>${r.count}</td>
            <td>${r.habitat}</td>
            <td>${r.gps}</td>
            <td>${r.time}</td>
        `;
        tbody.appendChild(row);
    });
}

/* Export CSV */
function exportCSV() {
    if (records.length === 0) {
        alert("No data to export");
        return;
    }

    let csv = "No.,Species,Count,Habitat,GPS,Time\n";

    records.forEach((r, i) => {
        csv += `${i + 1},${r.species},${r.count},${r.habitat},${r.gps},${r.time}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "insect_sampling.csv";
    a.click();

    URL.revokeObjectURL(url);
}

/* Export KML */
function exportKML() {
    if (records.length === 0) {
        alert("No data to export");
        return;
    }

    let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>Termite Sampling</name>
`;

    records.forEach((r, i) => {
        const [lat, lon] = r.gps.split(",").map(v => v.trim());
        kml += `
    <Placemark>
        <name>${r.species} (${r.count})</name>
        <description>
Habitat: ${r.habitat}
Count: ${r.count}
Recorded: ${r.time}
        </description>
        <Point>
            <coordinates>${lon},${lat},0</coordinates>
        </Point>
    </Placemark>
`;
    });

    kml += `
</Document>
</kml>
`;

    const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "insect_sampling.kml";
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>